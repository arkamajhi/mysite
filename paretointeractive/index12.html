<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pareto Frontier Explorer</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; background: #f5f5f5; color: #333; }
h2 { font-weight: 700; text-align: center; margin-bottom: 20px; }

.container { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 950px; margin: 0 auto; }

.panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.panel h3 { margin-top: 0; margin-bottom: 10px; font-weight: 700; font-size: 1.1em; }

.form-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
select, button, input[type="file"], input[type="number"], input[type="range"] { padding: 8px 10px; font-size: 14px; border-radius: 6px; border: 1px solid #ccc; flex: 1 1 150px; }
button { background-color: #2196F3; color: white; border: none; cursor: pointer; transition: 0.3s; }
button:hover { background-color: #1976D2; }

.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input { display: none; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.3s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: 0.3s; border-radius: 50%; }
input:checked + .slider { background-color: #2196F3; }
input:checked + .slider:before { transform: translateX(20px); }

svg { width: 100%; height: 500px; border-radius: 12px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

.toggles { display: grid; grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); gap: 15px; }
label { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }

.info-panel { margin-top: 10px; font-weight: 700; }
.tooltip { position: absolute; padding: 6px 10px; background: rgba(0,0,0,0.7); color: white; border-radius: 4px; font-size: 12px; pointer-events: none; }

/* Pulsating animation */
@keyframes pulse {
  0% { r: 6; opacity: 0.5; }
  50% { r: 12; opacity: 0.2; }
  100% { r: 6; opacity: 0.5; }
}
.pulse { fill: orange; animation: pulse 1.2s infinite; }
</style>
</head>
<body>

<h2>Pareto Frontier Explorer</h2>

<div class="container">

  <!-- File Upload -->
  <div class="panel">
    <h3>Step 1: Upload CSV File</h3>
    <input type="file" id="fileInput" accept=".csv">
  </div>

  <!-- X/Y Selection -->
  <div class="panel">
    <h3>Step 2: Choose Variables</h3>
    <div class="form-row">
      <label>X Variable: <select id="xVar"></select></label>
      <label>Y Variable: <select id="yVar"></select></label>
      <button id="plotBtn">Plot</button>
    </div>
  </div>

  <!-- Weighted Management Toggle -->
  <div class="panel">
    <h3>Weighted Management</h3>
    <label>Use Weighted Management: <label class="switch"><input type="checkbox" id="toggleWeighted"><span class="slider"></span></label></label>
    <div id="weightInputs" style="display:none; margin-top:10px;">
      <div class="form-row">
        <label>Management 1: <select id="mgmt1"></select></label>
        <label>Weight 1 (%): <input type="range" id="weight1" min="0" max="100" value="50"><input type="number" id="weightVal1" min="0" max="100" value="50"></label>
      </div>
      <div class="form-row">
        <label>Management 2: <select id="mgmt2"></select></label>
        <label>Weight 2 (%): <input type="range" id="weight2" min="0" max="100" value="50"><input type="number" id="weightVal2" min="0" max="100" value="50"></label>
      </div>
    </div>
  </div>

  <!-- Toggles -->
  <div class="panel">
    <h3>Toggle Points and Lines</h3>
    <div class="toggles">
      <strong>Dots</strong>
      <label style="color:red">55-year <label class="switch"><input type="checkbox" id="toggleR55" checked><span class="slider"></span></label></label>
      <label style="color:green">65-year <label class="switch"><input type="checkbox" id="toggleR65" checked><span class="slider"></span></label></label>
      <label style="color:blue">75-year <label class="switch"><input type="checkbox" id="toggleR75" checked><span class="slider"></span></label></label>

      <strong>Rotation Lines (Dotted)</strong>
      <label style="color:red">55-year <label class="switch"><input type="checkbox" id="toggleLineR55" checked><span class="slider"></span></label></label>
      <label style="color:green">65-year <label class="switch"><input type="checkbox" id="toggleLineR65" checked><span class="slider"></span></label></label>
      <label style="color:blue">75-year <label class="switch"><input type="checkbox" id="toggleLineR75" checked><span class="slider"></span></label></label>

      <strong>Overall Pareto Line</strong>
      <label style="color:black">Overall <label class="switch"><input type="checkbox" id="toggleLineOverall" checked><span class="slider"></span></label></label>
    </div>
  </div>

  <!-- Chart -->
  <div class="panel">
    <svg id="chart"></svg>
    <div class="info-panel" id="crossInfo">Weighted Cross: X=0, Y=0</div>
  </div>

</div>

<div class="tooltip" id="tooltip" style="opacity:0;"></div>

<script>
const svg = d3.select("#chart");
const tooltip = d3.select("#tooltip");
const crossInfo = d3.select("#crossInfo");
let data=[], xVar="", yVar="", cross, xScale, yScale;

// CSV upload
d3.select("#fileInput").on("change", function() {
  const file = this.files[0];
  if(!file) return;
  d3.csv(URL.createObjectURL(file)).then(csv => {
    data = csv;
    const vars = Object.keys(data[0]);
    d3.select("#xVar").selectAll("option").data(vars).join("option").text(d=>d).attr("value",d=>d);
    d3.select("#yVar").selectAll("option").data(vars).join("option").text(d=>d).attr("value",d=>d);
    const mgmtCodes = Array.from(new Set(data.map(d=>d["Management regime"])));
    d3.select("#mgmt1").selectAll("option").data(mgmtCodes).join("option").text(d=>d).attr("value",d=>d);
    d3.select("#mgmt2").selectAll("option").data(mgmtCodes).join("option").text(d=>d).attr("value",d=>d);
  });
});

// Toggle weighted management
d3.select("#toggleWeighted").on("change", function(){
  document.getElementById("weightInputs").style.display = this.checked ? "block":"none";
  if(cross) cross.style("display", this.checked ? null:"none");
  updateWeightedCross();
});

// Sync slider & number inputs dynamically
["weight1","weight2"].forEach((id,i)=>{
  const numId = "weightVal"+(i+1);
  const slider = d3.select("#"+id);
  const number = d3.select("#"+numId);
  slider.on("input", function(){ number.property("value", this.value); updateWeightedCross(); });
  number.on("input", function(){ slider.property("value", this.value); updateWeightedCross(); });
});

// Weighted point calculation
function getWeightedPoint(m1,m2,w1,w2){
  const filtered = data.filter(d=>+d["Climate code"]===1);
  const d1 = filtered.find(d=>d["Management regime"]===m1);
  const d2 = filtered.find(d=>d["Management regime"]===m2);
  if(!d1 || !d2) return null;
  const x = (w1*d1[xVar]+w2*d2[xVar])/(w1+w2);
  const y = (w1*d1[yVar]+w2*d2[yVar])/(w1+w2);
  return {x,y};
}

// Compute Pareto frontier
function computeParetoFront(points){
  if(points.length===0) return [];
  const sorted = points.sort((a,b)=>b.x - a.x);
  const pareto = [sorted[0]];
  for(const p of sorted){ if(p.y >= pareto[pareto.length-1].y) pareto.push(p); }
  return pareto;
}

// Plot chart
d3.select("#plotBtn").on("click", function(){
  xVar = d3.select("#xVar").property("value");
  yVar = d3.select("#yVar").property("value");
  if(!xVar || !yVar) return;

  const filtered = data.filter(d=>+d["Climate code"]===1);
  const points = filtered.map(d=>{
    const rot = +d["Management regime"].split("R")[1];
    let color = rot===55?"red":rot===65?"green":rot===75?"blue":"gray";
    return {x:+d[xVar], y:+d[yVar], color, rotation:rot, raw:d};
  });

  const frontiers = [55,65,75].map(rot=>{
    const pts = points.filter(p=>p.rotation===rot).map(p=>({x:p.x,y:p.y}));
    return {rotation:rot, frontier:computeParetoFront(pts)};
  });
  const overallFrontier = computeParetoFront(points.map(p=>({x:p.x,y:p.y})));

  svg.selectAll("*").remove();
  const width = parseInt(svg.style("width")), height = parseInt(svg.style("height"));
  const margin = {top:30,right:30,bottom:50,left:70};
  const innerWidth = width-margin.left-margin.right;
  const innerHeight = height-margin.top-margin.bottom;
  const g = svg.append("g").attr("transform",`translate(${margin.left},${margin.top})`);

  xScale = d3.scaleLinear().domain([0,d3.max(points,d=>d.x)]).range([0,innerWidth]);
  yScale = d3.scaleLinear().domain(d3.extent(points,d=>d.y)).nice().range([innerHeight,0]);

  // Axes
  g.append("g").attr("transform",`translate(0,${innerHeight})`).call(d3.axisBottom(xScale));
  g.append("text").attr("x",innerWidth/2).attr("y",innerHeight+40).text(xVar).style("font-weight","bold").style("text-anchor","middle");
  g.append("g").call(d3.axisLeft(yScale));
  g.append("text").attr("transform","rotate(-90)").attr("x",-innerHeight/2).attr("y",-50).text(yVar).style("font-weight","bold").style("text-anchor","middle");

  // Dots
  points.forEach(p=>{
    g.append("circle")
      .attr("cx",xScale(p.x)).attr("cy",yScale(p.y))
      .attr("r",4).attr("fill",p.color)
      .attr("class","dotR"+p.rotation)
      .on("mouseover",(event,d)=>{ tooltip.transition().duration(200).style("opacity",1);
        tooltip.html(`${xVar}: ${p.x.toFixed(2)}<br>${yVar}: ${p.y.toFixed(2)}`).style("left",(event.pageX+10)+"px").style("top",(event.pageY-28)+"px");})
      .on("mouseout",()=>tooltip.transition().duration(200).style("opacity",0));
  });

  // Rotation lines (dotted)
  frontiers.forEach(f=>{
    g.append("path").datum(f.frontier)
      .attr("fill","none")
      .attr("stroke",f.rotation===55?"red":f.rotation===65?"green":"blue")
      .attr("stroke-width",2)
      .attr("stroke-dasharray","5,5")
      .attr("class","paretoLineR"+f.rotation)
      .attr("d",d3.line().x(d=>xScale(d.x)).y(d=>yScale(d.y)).curve(d3.curveLinear));
  });

  // Overall line
  g.append("path").datum(overallFrontier)
    .attr("fill","none").attr("stroke","black")
    .attr("stroke-width",2).attr("class","paretoLineOverall")
    .attr("d",d3.line().x(d=>xScale(d.x)).y(d=>yScale(d.y)).curve(d3.curveLinear));

  // Weighted pulsating point
  const weightedInit = getWeightedPoint(d3.select("#mgmt1").property("value"),d3.select("#mgmt2").property("value"),
                                        +d3.select("#weight1").property("value"),+d3.select("#weight2").property("value"));
  cross = g.append("g").style("display", d3.select("#toggleWeighted").property("checked") ? null:"none");
  if(weightedInit){
    cross.append("circle").attr("class","pulse").attr("cx",xScale(weightedInit.x)).attr("cy",yScale(weightedInit.y)).attr("r",6)
      .on("mouseover",(event,d)=>{ tooltip.transition().duration(200).style("opacity",1);
        tooltip.html(`${xVar}: ${weightedInit.x.toFixed(2)}<br>${yVar}: ${weightedInit.y.toFixed(2)}`)
          .style("left",(event.pageX+10)+"px").style("top",(event.pageY-28)+"px");})
      .on("mouseout",()=>tooltip.transition().duration(200).style("opacity",0));
    cross.append("circle").attr("cx",xScale(weightedInit.x)).attr("cy",yScale(weightedInit.y)).attr("r",3).attr("fill","black");
    crossInfo.text(`Weighted Cross: X=${weightedInit.x.toFixed(2)}, Y=${weightedInit.y.toFixed(2)}`);
  }

  // Toggle events
  ["R55","R65","R75"].forEach(rot=>{
    d3.select("#toggle"+rot).on("change", function(){ svg.selectAll(".dot"+rot).attr("display",this.checked?null:"none"); });
    d3.select("#toggleLine"+rot).on("change", function(){ svg.selectAll(".paretoLine"+rot).attr("display",this.checked?null:"none"); });
  });
  d3.select("#toggleLineOverall").on("change", function(){ svg.selectAll(".paretoLineOverall").attr("display",this.checked?null:"none"); });
});

// Update weighted point dynamically
function updateWeightedCross(){
  if(!cross || !d3.select("#toggleWeighted").property("checked")) return;
  const m1=d3.select("#mgmt1").property("value");
  const m2=d3.select("#mgmt2").property("value");
  const w1=+d3.select("#weight1").property("value");
  const w2=+d3.select("#weight2").property("value");
  const weighted=getWeightedPoint(m1,m2,w1,w2);
  if(!weighted) return;
  cross.selectAll("circle").attr("cx",xScale(weighted.x)).attr("cy",yScale(weighted.y));
  crossInfo.text(`Weighted Cross: X=${weighted.x.toFixed(2)}, Y=${weighted.y.toFixed(2)}`);
}
</script>
</body>
</html>
