<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pareto Frontier Explorer - Material UI</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Roboto', sans-serif;
    margin: 20px;
    background: #f5f5f5;
    color: #333;
  }
  h2 {
    font-weight: 700;
    margin-bottom: 20px;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  label {
    font-size: 14px;
  }
  svg {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  /* Material-style toggle switches */
  .switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
  }
  .switch input { display: none; }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 34px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 16px; width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background-color: #2196F3;
  }
  input:checked + .slider:before {
    transform: translateX(20px);
  }
</style>
</head>
<body>

<h2>Pareto Frontier Explorer</h2>

<div class="controls">
  <div class="control-group">
    <input type="file" id="fileInput" accept=".csv">
  </div>

  <div class="control-group">
    <label>X Variable:</label>
    <select id="xVar"></select>
    <label>Y Variable:</label>
    <select id="yVar"></select>
    <button id="plotBtn">Plot</button>
  </div>

  <div class="control-group">
    <strong>Show Dots</strong>
    <label>55-year
      <label class="switch">
        <input type="checkbox" id="toggleR55" checked>
        <span class="slider"></span>
      </label>
    </label>
    <label>65-year
      <label class="switch">
        <input type="checkbox" id="toggleR65" checked>
        <span class="slider"></span>
      </label>
    </label>
    <label>75-year
      <label class="switch">
        <input type="checkbox" id="toggleR75" checked>
        <span class="slider"></span>
      </label>
    </label>
  </div>

  <div class="control-group">
    <strong>Show Rotation Lines (Dotted)</strong>
    <label>55-year
      <label class="switch">
        <input type="checkbox" id="toggleLineR55" checked>
        <span class="slider"></span>
      </label>
    </label>
    <label>65-year
      <label class="switch">
        <input type="checkbox" id="toggleLineR65" checked>
        <span class="slider"></span>
      </label>
    </label>
    <label>75-year
      <label class="switch">
        <input type="checkbox" id="toggleLineR75" checked>
        <span class="slider"></span>
      </label>
    </label>
  </div>

  <div class="control-group">
    <strong>Show Overall Pareto Line</strong>
    <label>Overall
      <label class="switch">
        <input type="checkbox" id="toggleLineOverall" checked>
        <span class="slider"></span>
      </label>
    </label>
  </div>
</div>

<svg id="chart" width="850" height="500"></svg>

<script>
const svg = d3.select("#chart");
const width = +svg.attr("width"), height = +svg.attr("height");
let data = [];

d3.select("#fileInput").on("change", function() {
  const file = this.files[0];
  d3.csv(URL.createObjectURL(file)).then(csv => {
    data = csv;
    const vars = Object.keys(data[0]);
    d3.select("#xVar").selectAll("option")
      .data(vars).join("option").text(d=>d).attr("value",d=>d);
    d3.select("#yVar").selectAll("option")
      .data(vars).join("option").text(d=>d).attr("value",d=>d);
  });
});

d3.select("#plotBtn").on("click", function() {
  const xVar = d3.select("#xVar").property("value");
  const yVar = d3.select("#yVar").property("value");

  const filtered = data.filter(d => +d["Climate code"] === 1);

  const points = filtered.map(d => {
    let rotStr = d["Management regime"];
    let rot = +rotStr.split("R")[1];
    let color = "gray";
    let rotation = null;
    if (rot === 55) { color = "red"; rotation = 55; }
    else if (rot === 65) { color = "green"; rotation = 65; }
    else if (rot === 75) { color = "blue"; rotation = 75; }
    return { x: +d[xVar], y: +d[yVar], color: color, rotation: rotation };
  });

  const frontiers = [55,65,75].map(rot => {
    const pts = points.filter(p => p.rotation===rot).map(p => ({x:p.x, y:p.y}));
    return {rotation: rot, frontier: computeParetoFront(pts)};
  });

  const overallFrontier = computeParetoFront(points.map(p=>({x:p.x, y:p.y})));

  svg.selectAll("*").remove();

  const xMax = d3.max(points, d=>d.x);
  const yExtent = d3.extent(points, d=>d.y);
  const x = d3.scaleLinear().domain([0, xMax]).range([70, width-30]);
  const y = d3.scaleLinear().domain(yExtent).nice().range([height-50, 30]);

  svg.append("g").attr("transform", `translate(0,${height-50})`).call(d3.axisBottom(x));
  svg.append("g").attr("transform", `translate(70,0)`).call(d3.axisLeft(y));

  // Bold axis labels
  svg.append("text")
    .attr("x", width/2).attr("y", height).attr("text-anchor","middle")
    .attr("font-weight","700")
    .text(xVar);
  svg.append("text")
    .attr("x", -height/2).attr("y", 25).attr("transform","rotate(-90)")
    .attr("text-anchor","middle")
    .attr("font-weight","700")
    .text(yVar);

  svg.selectAll("circle")
    .data(points)
    .join("circle")
    .attr("cx", d=>x(d.x))
    .attr("cy", d=>y(d.y))
    .attr("r", 4)
    .attr("fill", d=>d.color)
    .attr("class", d=> "dotR" + d.rotation);

  // Rotation-specific dotted lines
  frontiers.forEach(f => {
    svg.append("path")
      .datum(f.frontier)
      .attr("fill","none")
      .attr("stroke", f.rotation===55 ? "red" : f.rotation===65 ? "green" : "blue")
      .attr("stroke-width", 2)
      .attr("stroke-dasharray", "5,5")
      .attr("class","paretoLineR"+f.rotation)
      .attr("d", d3.line().x(d=>x(d.x)).y(d=>y(d.y)).curve(d3.curveLinear));
  });

  // Overall solid black line
  svg.append("path")
    .datum(overallFrontier)
    .attr("fill","none")
    .attr("stroke","black")
    .attr("stroke-width",2)
    .attr("class","paretoLineOverall")
    .attr("d", d3.line().x(d=>x(d.x)).y(d=>y(d.y)).curve(d3.curveLinear));

  // Cross at midpoint
  const crossPoint = computeCross(points);
  const cross = svg.append("g")
    .attr("transform", `translate(${x(crossPoint.x)},${y(crossPoint.y)})`)
    .call(d3.drag().on("drag", function(event){
      d3.select(this).attr("transform", `translate(${event.x},${event.y})`);
    }));
  cross.append("line").attr("x1",-8).attr("x2",8).attr("stroke","black").attr("stroke-width",2);
  cross.append("line").attr("y1",-8).attr("y2",8).attr("stroke","black").attr("stroke-width",2);

  // Toggle sliders
  ["R55","R65","R75"].forEach(rot=>{
    d3.select("#toggle"+rot).on("change", function() { svg.selectAll(".dot"+rot).attr("display", this.checked ? null : "none"); });
    d3.select("#toggleLine"+rot).on("change", function() { svg.selectAll(".paretoLine"+rot).attr("display", this.checked ? null : "none"); });
  });
  d3.select("#toggleLineOverall").on("change", function() { svg.selectAll(".paretoLineOverall").attr("display", this.checked ? null : "none"); });
});

function computeParetoFront(points){
  if(points.length===0) return [];
  const sorted = points.sort((a,b)=>b.x - a.x);
  const pareto = [sorted[0]];
  for (const p of sorted){
    if(p.y >= pareto[pareto.length-1].y)
      pareto.push(p);
  }
  return pareto;
}
function computeCross(points){
  const xs = points.map(p=>p.x);
  const ys = points.map(p=>p.y);
  return {x: d3.mean(xs), y: d3.mean(ys)};
}
</script>

</body>
</html>
